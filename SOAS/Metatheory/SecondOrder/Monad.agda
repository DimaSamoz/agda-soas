
open import SOAS.Metatheory.Syntax

-- Term monad
module SOAS.Metatheory.SecondOrder.Monad {T : Set}(Syn : Syntax {T}) where

open Syntax Syn

open import SOAS.Metatheory.FreeMonoid Syn
open import SOAS.Metatheory.TermFunctor Syn
open import SOAS.Metatheory.SecondOrder.Strength Syn

open import SOAS.Common
open import SOAS.Families.Core {T}
open import SOAS.Context
open import SOAS.Variable
open import SOAS.Construction.Structure

import SOAS.Abstract.Coalgebra as â†’â–¡ ; open â†’â–¡.Sorted

open import Categories.Monad

open import SOAS.Metatheory Syn

open import SOAS.Linear.Exponential
open import SOAS.Linear.Tensor
open import SOAS.Linear.Strength
open import SOAS.Linear.Distributor

open Theory hiding (runit)

private
  variable
    X Y Z : Family
    ğ’³ ğ’´ ğ’µ â„³ : Familyâ‚›
    Î“ Î” Î˜ Î : Ctx
    Î± Ï„ : T

-- A Î£-monoid â„³ is a ğ•‹-algebra - it absorbs the term functor
module Absorb (Î£â„³áµ : Î£Mon â„³) where
  open FÎ£M â„³ Î£â„³áµ id public

  ğ•’ğ•“ğ•¤ : ğ•‹ â„³ â‡¾Ì£ â„³
  ğ•’ğ•“ğ•¤ = ğ•–ğ•©ğ•¥

  ğ•’ğ•“ğ•¤áµ‡â‡’ : Coalgâ‡’ (ğ•‹áµ‡ â„³) áµ‡ ğ•’ğ•“ğ•¤
  ğ•’ğ•“ğ•¤áµ‡â‡’ = ğ•–ğ•©ğ•¥áµ‡â‡’

  ğ•’ğ•“ğ•¤áµƒâ‡’ : SynAlgâ‡’ â„³ (ğ•‹áµƒ â„³) â„³áµƒ ğ•’ğ•“ğ•¤
  ğ•’ğ•“ğ•¤áµƒâ‡’ = ğ•¤ğ•–ğ•áµƒâ‡’

-- ğ•‹ ğ’³ is a ğ•‹-algebra with ğ•›ğ• ğ•šğ•Ÿ as the algebra map
module Join ğ’³ = Absorb (Î£ğ•‹áµ ğ’³)
ğ•›ğ• ğ•šğ•Ÿ : ğ•‹ (ğ•‹ ğ’³) â‡¾Ì£ ğ•‹ ğ’³
ğ•›ğ• ğ•šğ•Ÿ {ğ’³} = Join.ğ•’ğ•“ğ•¤ ğ’³

ğ•›ğ• ğ•šğ•Ÿáµ‡â‡’ : Coalgâ‡’ (ğ•‹áµ‡ (ğ•‹ ğ’³)) (ğ•‹áµ‡ ğ’³) ğ•›ğ• ğ•šğ•Ÿ
ğ•›ğ• ğ•šğ•Ÿáµ‡â‡’ {ğ’³} = ğ•¤ğ•–ğ•áµ‡â‡’ (ğ•‹ ğ’³) (ğ•‹áµ‡ ğ’³) (record { ğ‘ğ‘™ğ‘” = ğ•’ğ•ğ•˜ ğ’³ ; ğ‘£ğ‘ğ‘Ÿ = ğ•§ğ•’ğ•£ ğ’³ ; ğ‘šğ‘£ğ‘ğ‘Ÿ = Î» ğ”ª Îµ â†’ ğ•¤ğ•¦ğ•“ ğ’³ ğ”ª Îµ }) (record
    { âŸ¨ğ‘ğ‘™ğ‘”âŸ© = Î»{ {t = t} â†’ Renaming.âŸ¨ğ•’âŸ© ğ’³}
    ; âŸ¨ğ‘£ğ‘ğ‘ŸâŸ© = Î»{ {v = v} â†’ Renaming.âŸ¨ğ•§âŸ© ğ’³ }
    ; âŸ¨ğ‘šğ‘£ğ‘ğ‘ŸâŸ© = Î»{ {ğ”ª = t}{Îµ} â†’ dext Î» Ï â†’ ğ•¤ğ•¦ğ•“á¶œ.râˆ˜f ğ’³ } })
    where open â‰¡-Reasoning

ğ•›ğ• ğ•šğ•Ÿ-nat : (f : ğ’³ â‡¾Ì£ ğ’´)(t : ğ•‹ (ğ•‹ ğ’³) Î± Î“) â†’ ğ•›ğ• ğ•šğ•Ÿ (ğ•‹â‚ (ğ•‹â‚ f) t) â‰¡ ğ•‹â‚ f (ğ•›ğ• ğ•šğ•Ÿ t)
ğ•›ğ• ğ•šğ•Ÿ-nat f t = Î¼.commute f where open Monad Î£Mon:Monad

module _ (Î£â„³áµ : Î£Mon â„³) where
  open Absorb Î£â„³áµ

  -- Generalisation of the monad associativity law
  --              ğ•›ğ• ğ•šğ•Ÿ             ğ•’ğ•“ğ•¤
  --  ğ•‹ (ğ•‹ â„³) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ğ•‹ â„³ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â„³
  --      â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ğ•‹ â„³ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
  --           ğ•‹ ğ•’ğ•“ğ•¤               ğ•’ğ•“ğ•¤
  --
  ğ•’ğ•“ğ•¤âˆ˜ğ•›ğ• ğ•šğ•Ÿâ‰ˆ : MapEqâ‚€ (ğ•‹ â„³) â„³ (ğ•’ğ•“ğ•¤ âˆ˜ ğ•›ğ• ğ•šğ•Ÿ) (ğ•’ğ•“ğ•¤ âˆ˜ ğ•‹â‚ ğ•’ğ•“ğ•¤)
  ğ•’ğ•“ğ•¤âˆ˜ğ•›ğ• ğ•šğ•Ÿâ‰ˆ = record
    { áµƒ = record { ğ‘ğ‘™ğ‘” = â„³ğ‘ğ‘™ğ‘” ; ğ‘£ğ‘ğ‘Ÿ = Î· ; ğ‘šğ‘£ğ‘ğ‘Ÿ = Î¼ âˆ˜ ğ•’ğ•“ğ•¤ }
    ; fâŸ¨ğ‘£âŸ© = Î»{ {x = v} â†’ begin
          ğ•’ğ•“ğ•¤ (ğ•›ğ• ğ•šğ•Ÿ (ğ•§ğ•’ğ•£ (ğ•‹ â„³) v))   â‰¡âŸ¨ cong ğ•’ğ•“ğ•¤ (Join.âŸ¨ğ•§âŸ© â„³) âŸ©
          ğ•’ğ•“ğ•¤ (ğ•§ğ•’ğ•£ â„³ v)             â‰¡âŸ¨ Absorb.âŸ¨ğ•§âŸ© Î£â„³áµ âŸ©
          Î· v
      âˆ }
    ; fâŸ¨ğ‘šâŸ© = Î»{ {ğ”ª = t}{Îµ} â†’ begin
          ğ•’ğ•“ğ•¤ (ğ•›ğ• ğ•šğ•Ÿ (ğ•ğ•§ğ•’ğ•£ (ğ•‹ â„³) t Îµ)) â‰¡âŸ¨ cong ğ•’ğ•“ğ•¤ (Join.âŸ¨ğ•âŸ© â„³) âŸ©
          ğ•’ğ•“ğ•¤ (ğ•¤ğ•¦ğ•“ â„³ t (ğ•›ğ• ğ•šğ•Ÿ âˆ˜ Îµ))    â‰¡âŸ¨ Absorb.ğ•–ğ•©ğ•¥áµâ‡’.âŸ¨Î¼âŸ© Î£â„³áµ âŸ©
          Î¼ (ğ•’ğ•“ğ•¤ t) (ğ•’ğ•“ğ•¤ âˆ˜ ğ•›ğ• ğ•šğ•Ÿ âˆ˜ Îµ)
      âˆ }
    ; fâŸ¨ğ‘âŸ© = Î»{ {t = t} â†’ begin
          ğ•’ğ•“ğ•¤ (ğ•›ğ• ğ•šğ•Ÿ (ğ•’ğ•ğ•˜ (ğ•‹ â„³) t))   â‰¡âŸ¨ cong ğ•’ğ•“ğ•¤ (Join.âŸ¨ğ•’âŸ© â„³) âŸ©
          ğ•’ğ•“ğ•¤ (ğ•’ğ•ğ•˜ â„³ (â…€â‚ ğ•›ğ• ğ•šğ•Ÿ t))   â‰¡âŸ¨ Absorb.âŸ¨ğ•’âŸ© Î£â„³áµ âŸ©
          â„³ğ‘ğ‘™ğ‘” (â…€â‚ ğ•’ğ•“ğ•¤ (â…€â‚ ğ•›ğ• ğ•šğ•Ÿ t))  â‰¡Ë˜âŸ¨ cong â„³ğ‘ğ‘™ğ‘” â…€.homomorphism âŸ©
          â„³ğ‘ğ‘™ğ‘” (â…€â‚ (ğ•’ğ•“ğ•¤ âˆ˜ ğ•›ğ• ğ•šğ•Ÿ) t)
      âˆ }
    ; gâŸ¨ğ‘£âŸ© = Î»{ {x = v} â†’ begin
          ğ•’ğ•“ğ•¤ (ğ•‹â‚ ğ•’ğ•“ğ•¤ (ğ•§ğ•’ğ•£ (ğ•‹ â„³) v)) â‰¡âŸ¨ cong ğ•’ğ•“ğ•¤ (ğ•§ğ•’ğ•£-nat ğ•’ğ•“ğ•¤ v) âŸ©
          ğ•’ğ•“ğ•¤ (ğ•§ğ•’ğ•£ â„³ v)             â‰¡âŸ¨ Absorb.âŸ¨ğ•§âŸ© Î£â„³áµ âŸ©
          Î· v
      âˆ }
    ; gâŸ¨ğ‘šâŸ© = Î»{ {ğ”ª = t}{Îµ} â†’ begin
          ğ•’ğ•“ğ•¤ (ğ•‹â‚ ğ•’ğ•“ğ•¤ (ğ•ğ•§ğ•’ğ•£ (ğ•‹ â„³) t Îµ))       â‰¡âŸ¨ cong ğ•’ğ•“ğ•¤ (ğ•ğ•§ğ•’ğ•£-nat ğ•’ğ•“ğ•¤ t Îµ) âŸ©
          ğ•’ğ•“ğ•¤ (ğ•ğ•§ğ•’ğ•£ â„³ (ğ•’ğ•“ğ•¤ t) (ğ•‹â‚ ğ•’ğ•“ğ•¤ âˆ˜ Îµ))   â‰¡âŸ¨ Absorb.âŸ¨ğ•âŸ© Î£â„³áµ âŸ©
          Î¼ (ğ•’ğ•“ğ•¤ t) (ğ•’ğ•“ğ•¤ âˆ˜ ğ•‹â‚ ğ•’ğ•“ğ•¤ âˆ˜ Îµ)
      âˆ }
    ; gâŸ¨ğ‘âŸ© = Î»{ {t = t} â†’ begin
          ğ•’ğ•“ğ•¤ (ğ•‹â‚ ğ•’ğ•“ğ•¤ (ğ•’ğ•ğ•˜ (ğ•‹ â„³) t))     â‰¡âŸ¨ cong ğ•’ğ•“ğ•¤ (ğ•’ğ•ğ•˜-nat ğ•’ğ•“ğ•¤ t) âŸ©
          ğ•’ğ•“ğ•¤ (ğ•’ğ•ğ•˜ â„³ (â…€â‚ (ğ•‹â‚ ğ•’ğ•“ğ•¤) t))   â‰¡âŸ¨ Absorb.âŸ¨ğ•’âŸ© Î£â„³áµ âŸ©
          â„³ğ‘ğ‘™ğ‘” (â…€â‚ ğ•’ğ•“ğ•¤ (â…€â‚ (ğ•‹â‚ ğ•’ğ•“ğ•¤) t))  â‰¡Ë˜âŸ¨ cong â„³ğ‘ğ‘™ğ‘” â…€.homomorphism âŸ©
          â„³ğ‘ğ‘™ğ‘” (â…€â‚ (ğ•’ğ•“ğ•¤ âˆ˜ (ğ•‹â‚ ğ•’ğ•“ğ•¤)) t)
      âˆ }
    }
    where
    open â‰¡-Reasoning
    module ğ•›ğ• ğ•šğ•Ÿ = SynAlgâ‡’ (ğ•‹ â„³) (Join.ğ•’ğ•“ğ•¤áµƒâ‡’ â„³)

  ğ•’ğ•“ğ•¤âˆ˜ğ•›ğ• ğ•šğ•Ÿ : (t : ğ•‹ (ğ•‹ â„³) Î± Î“)
         â†’ ğ•’ğ•“ğ•¤ (ğ•›ğ• ğ•šğ•Ÿ t) â‰¡ ğ•’ğ•“ğ•¤ (ğ•‹â‚ ğ•’ğ•“ğ•¤ t)
  ğ•’ğ•“ğ•¤âˆ˜ğ•›ğ• ğ•šğ•Ÿ  t = MapEqâ‚€.â‰ˆ (ğ•‹ â„³) ğ•’ğ•“ğ•¤âˆ˜ğ•›ğ• ğ•šğ•Ÿâ‰ˆ t

  -- Absorption and unit
  --       ğ•¦ğ•Ÿğ•šğ•¥          ğ•’ğ•“ğ•¤
  --   â„³ â”€â”€â”€â”€â”€â”€â”€ ğ•‹ â„³ â”€â”€â”€â”€â”€â”€ â„³
  --    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  --              id
  --
  ğ•’ğ•“ğ•¤âˆ˜ğ•¦ğ•Ÿğ•šğ•¥ : (m : â„³ Î± Î“) â†’ ğ•’ğ•“ğ•¤ (ğ•¦ğ•Ÿğ•šğ•¥ m) â‰¡ m
  ğ•’ğ•“ğ•¤âˆ˜ğ•¦ğ•Ÿğ•šğ•¥ m = begin
        ğ•’ğ•“ğ•¤ (ğ•¦ğ•Ÿğ•šğ•¥ m)             â‰¡âŸ¨âŸ©
        ğ•’ğ•“ğ•¤ (ğ•ğ•§ğ•’ğ•£ â„³ m (ğ•§ğ•’ğ•£ â„³))  â‰¡âŸ¨ Absorb.âŸ¨ğ•âŸ© Î£â„³áµ âŸ©
        Î¼ m (ğ•’ğ•“ğ•¤ âˆ˜ ğ•§ğ•’ğ•£ â„³)       â‰¡âŸ¨ Î¼â‰ˆâ‚‚ (Absorb.âŸ¨ğ•§âŸ© Î£â„³áµ) âŸ©
        Î¼ m Î·                   â‰¡âŸ¨ runit âŸ©
        m                       âˆ where open â‰¡-Reasoning

-- | Monad laws

--                 ğ•›ğ• ğ•šğ•Ÿ               ğ•’ğ•“ğ•¤
--  ğ•‹ (ğ•‹ (ğ•‹ ğ’³)) â”€â”€â”€â”€â”€â”€â”€â”€ ğ•‹ (ğ•‹ ğ’³) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ (ğ•‹ ğ’³)
--       â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ğ•‹ (ğ•‹ ğ’³) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
--             ğ•‹ ğ•’ğ•“ğ•¤                 ğ•’ğ•“ğ•¤
--
ğ•›ğ• ğ•šğ•Ÿâˆ˜ğ•›ğ• ğ•šğ•Ÿ : (t : ğ•‹ (ğ•‹ (ğ•‹ ğ’³)) Î± Î“)
       â†’ ğ•›ğ• ğ•šğ•Ÿ (ğ•›ğ• ğ•šğ•Ÿ t) â‰¡ ğ•›ğ• ğ•šğ•Ÿ (ğ•‹â‚ ğ•›ğ• ğ•šğ•Ÿ t)
ğ•›ğ• ğ•šğ•Ÿâˆ˜ğ•›ğ• ğ•šğ•Ÿ {ğ’³} t = ğ•’ğ•“ğ•¤âˆ˜ğ•›ğ• ğ•šğ•Ÿ (Î£ğ•‹áµ ğ’³) t

--         ğ•¦ğ•Ÿğ•šğ•¥             ğ•›ğ• ğ•šğ•Ÿ
--   ğ•‹ ğ’³ â”€â”€â”€â”€â”€â”€ ğ•‹ (ğ•‹ ğ’³) â”€â”€â”€â”€â”€â”€ ğ•‹ ğ’³
--    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
--                id
--
ğ•›ğ• ğ•šğ•Ÿâˆ˜ğ•¦ğ•Ÿğ•šğ•¥ : (t : ğ•‹ ğ’³ Î± Î“) â†’ ğ•›ğ• ğ•šğ•Ÿ (ğ•¦ğ•Ÿğ•šğ•¥ t) â‰¡ t
ğ•›ğ• ğ•šğ•Ÿâˆ˜ğ•¦ğ•Ÿğ•šğ•¥ {ğ’³} t = ğ•’ğ•“ğ•¤âˆ˜ğ•¦ğ•Ÿğ•šğ•¥ (Î£ğ•‹áµ ğ’³) t

--        ğ•‹ ğ•¦ğ•Ÿğ•šğ•¥            ğ•›ğ• ğ•šğ•Ÿ
--   ğ•‹ ğ’³ â”€â”€â”€â”€â”€â”€â”€ ğ•‹ (ğ•‹ ğ’³) â”€â”€â”€â”€â”€â”€ ğ•‹ ğ’³
--    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
--                  id
--
ğ•›ğ• ğ•šğ•Ÿâˆ˜ğ•‹ğ•¦ğ•Ÿğ•šğ•¥ : (t : ğ•‹ ğ’³ Î± Î“) â†’ ğ•›ğ• ğ•šğ•Ÿ (ğ•‹â‚ ğ•¦ğ•Ÿğ•šğ•¥ t) â‰¡ t
ğ•›ğ• ğ•šğ•Ÿâˆ˜ğ•‹ğ•¦ğ•Ÿğ•šğ•¥ t = Monad.identityË¡ Î£Mon:Monad
